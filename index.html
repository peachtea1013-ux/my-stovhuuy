<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="在庫管理">
    <meta name="theme-color" content="#1a73e8">
    <title>在庫管理ツール</title>
    <style>
        /* ========== リセット・基本スタイル ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        input, textarea, select {
            -webkit-appearance: none;
            appearance: none;
            -webkit-user-select: text;
            user-select: text;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
        }

        /* ========== レイアウト ========== */
        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #1765cc 100%);
            color: white;
            padding: 12px 16px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            flex: 1;
            min-width: 60px;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
            background: white;
        }

        .nav-tab:active {
            background: rgba(26, 115, 232, 0.1);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            display: none;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 16px;
        }

        .content-area.active {
            display: flex;
            flex-direction: column;
        }

        /* ========== フォーム要素 ========== */
        .form-group {
            padding: 10px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        /* 2列フォームレイアウト */
        .form-group-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .form-group-row .form-group {
            border-bottom: none;
            border-right: 1px solid #f0f0f0;
            padding: 10px 12px;
        }

        .form-group-row .form-group:nth-child(2n) {
            border-right: none;
        }

        .form-group-row .form-group:nth-child(n+3) {
            border-top: 1px solid #f0f0f0;
        }

        /* 全幅フォーム（備考など） */
        .form-group-full {
            grid-column: 1 / -1;
            border: none;
            border-top: 1px solid #f0f0f0;
            padding: 10px 16px;
        }

        /* 棚卸モーダル専用：項目の列幅を狭くしてコンパクトに表示 */
        #stocktakeModal .modal-body {
            padding: 12px 12px;
        }

        #stocktakeModal .form-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 6px;
            border-bottom: 1px solid #f5f5f5;
        }

        #stocktakeModal .form-group label {
            flex: 0 0 34%;
            font-size: 13px;
            margin-bottom: 0;
        }

        #stocktakeModal .form-group input {
            flex: 1 1 66%;
            padding: 8px 10px;
            font-size: 14px;
        }

        /* キーボード（テンキー）表示時にモーダルが押し上げられないよう固定表示 */
        body.keyboard-open-stocktake #stocktakeModal {
            align-items: flex-start;
            justify-content: flex-start;
        }

        body.keyboard-open-stocktake #stocktakeModal .modal-content {
            position: fixed !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            top: 10vh !important;
            margin: 0 auto !important;
            width: 92% !important;
            max-height: 65vh !important;
            overflow: auto !important;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background: white;
            color: #333;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ========== ボタン ========== */
        .btn {
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:active {
            background: #1765cc;
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:active {
            background: #e0e0e0;
            transform: scale(0.98);
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:active {
            background: #b71c1c;
            transform: scale(0.98);
        }

        .btn-success {
            background: #388e3c;
            color: white;
        }

        .btn-success:active {
            background: #2e7d32;
            transform: scale(0.98);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px 16px;
        }

        .btn-group.full {
            grid-template-columns: 1fr;
        }

        /* ========== リスト表示 ========== */
        .list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .list-item:active {
            background: #f5f5f5;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .list-item-badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            background: #f0f0f0;
            color: #666;
        }

        .list-item-text {
            font-size: 13px;
            color: #666;
            margin: 2px 0;
        }

        .list-empty {
            padding: 32px 16px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }

        /* ========== アラート・色分け ========== */
        .alert-low {
            background: rgba(211, 47, 47, 0.1);
            border-left: 4px solid #d32f2f;
        }

        .alert-ordering {
            background: rgba(245, 127, 23, 0.1);
            border-left: 4px solid #f57f17;
        }

        .list-item.alert-low {
            background: rgba(211, 47, 47, 0.08);
        }

        .list-item.alert-ordering {
            background: rgba(245, 127, 23, 0.08);
        }

        .stock-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            display: inline-block;
        }

        .stock-badge.low {
            background: #d32f2f;
        }

        .stock-badge.ordering {
            background: #f57f17;
        }

        .stock-badge.normal {
            background: #388e3c;
        }

        /* ========== モーダル ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* 背景の半透明を無くして、カレンダーが暗くならないようにする */
            background: transparent;
            display: none;
            align-items: flex-end;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 16px 16px 0 0;
            padding: 0;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -2px 16px rgba(0,0,0,0.15);
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            flex-shrink: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #999;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:active {
            background: #f5f5f5;
            border-radius: 6px;
        }

        .modal-body {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #f0f0f0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: white;
            flex-shrink: 0;
            z-index: 10;
        }

        /* 棚卸モーダルを画面上部5%に固定表示 */
        #stocktakeModal {
            align-items: flex-start;
            justify-content: flex-start;
        }

        #stocktakeModal .modal-content {
            transform: translateY(0) !important;
            margin: 25vh auto 0 auto;
            width: 92%;
            max-height: 85vh;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.18);
        }

        /* ========== 検索・フィルタ ========== */
        .search-box {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .search-box input {
            flex: 1;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #d0d0d0;
            background: white;
            color: #333;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .chip.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .chip:active {
            transform: scale(0.95);
        }

        /* ========== テーブル表示 ========== */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table thead {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .table th {
            padding: 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .table tr:active {
            background: #f9f9f9;
        }

        /* ========== 修正履歴フラグ ========== */
        .modified-badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* ========== ボトムシート用背景スクロール禁止 ========== */
        body.modal-open {
            overflow: hidden;
        }

        /* ========== iPhoneノッチ対応 ========== */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(12px, env(safe-area-inset-top));
            }

            .modal-content {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ヘッダー -->
        <div class="header">在庫管理ツール</div>

        <!-- ナビゲーション -->
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" data-screen="inventory">在庫操作</button>
            <button class="nav-tab" data-screen="history">操作履歴</button>
            <button class="nav-tab" data-screen="master">商品管理</button>
            <button class="nav-tab" data-screen="calendar">交換周期</button>
            <button class="nav-tab" data-screen="export">データ連携</button>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 在庫操作画面 -->
            <div id="inventory" class="content-area active">
                <div style="position: relative;">
                    <div style="display: flex; gap: 8px; padding: 12px 16px; background: white; border-bottom: 1px solid #f0f0f0; align-items: stretch;">
                        <input type="text" id="inventorySearch" placeholder="商品名を検索..." style="flex: 1; padding: 10px 12px; font-size: 16px; border: 1px solid #d0d0d0; border-radius: 6px;">
                        <button id="categoryToggleBtn" class="btn btn-primary" style="flex: 0 0 auto; white-space: nowrap;">カテゴリー</button>
                    </div>
                    <div class="filter-chips" id="categoryFilter" style="display: none;"></div>
                </div>
                <div class="filter-chips" id="stockFilter">
                    <button class="chip" id="lowStockBtn" onclick="toggleLowStockFilter()">在庫不足のみ</button>
                </div>
                <div id="inventoryList" style="flex: 1; overflow-y: auto;"></div>
            </div>

            <!-- 操作履歴画面 -->
            <div id="history" class="content-area">
                <div class="search-box">
                    <input type="text" id="historySearch" placeholder="検索...">
                </div>
                <div class="filter-chips" id="historyFilter">
                    <button class="chip active" data-filter="all">全て</button>
                    <button class="chip" data-filter="use">使用</button>
                    <button class="chip" data-filter="receive">納入</button>
                    <button class="chip" data-filter="stocktake">棚卸</button>
                    <button class="chip" data-filter="modify">修正</button>
                </div>
                <div id="historyList" style="flex: 1; overflow-y: auto;"></div>
            </div>

            <!-- 商品管理画面 -->
            <div id="master" class="content-area">
                <div style="padding: 12px 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-primary" id="newProductBtn">新規商品登録</button>
                    <button class="btn btn-secondary" id="stocktakeBtn">棚卸を開始</button>
                </div>
                <div class="search-box">
                    <input type="text" id="masterSearch" placeholder="商品を検索...">
                </div>
                <div id="masterList" style="flex: 1; overflow-y: auto;"></div>
            </div>

            <!-- 交換周期カレンダー画面 -->
            <div id="calendar" class="content-area">
                <div style="display: flex; gap: 12px; padding: 12px 16px; background: white; border-bottom: 1px solid #f0f0f0; align-items: center;">
                    <button id="prevMonthBtn" class="btn btn-secondary" style="flex: 0 0 auto; padding: 8px 12px;">◀ 前月</button>
                    <div id="monthDisplay" style="flex: 1; text-align: center; font-weight: 600; font-size: 16px;"></div>
                    <button id="nextMonthBtn" class="btn btn-secondary" style="flex: 0 0 auto; padding: 8px 12px;">次月 ▶</button>
                </div>
                <div id="calendarContainer" style="flex: 2; overflow-y: auto; padding: 12px 16px; border-bottom: 1px solid #f0f0f0;"></div>
                <div id="scheduleList" style="flex: 1; overflow-y: auto; border-top: 1px solid #f0f0f0;"></div>
            </div>

            <!-- データ連携画面 -->
            <div id="export" class="content-area">
                <div class="form-group">
                    <label>データのエクスポート・インポート</label>
                    <p style="font-size: 13px; color: #666; margin: 8px 0;">
                        マスターデータと操作履歴をCSV形式でエクスポート・インポートできます。
                    </p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="exportMasterBtn">マスター<br>エクスポート</button>
                    <button class="btn btn-secondary" id="importMasterBtn">マスター<br>インポート</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="exportHistoryBtn">履歴<br>エクスポート</button>
                    <button class="btn btn-secondary" id="importHistoryBtn">履歴<br>インポート</button>
                </div>
                <div class="form-group">
                    <label>バックアップ</label>
                    <div class="btn-group full">
                        <button class="btn btn-secondary" id="backupBtn">全データバックアップ</button>
                    </div>
                    <div class="btn-group full">
                        <button class="btn btn-danger" id="restoreBtn">復元...</button>
                    </div>
                    <div class="btn-group full">
                        <button class="btn btn-danger" id="initializeBtn" title="全てのデータを初期化します">初期化（全データ削除）</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- モーダル: 使用・納入操作 -->
    <div class="modal-overlay" id="operationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="operationTitle">使用</h2>
                <button class="modal-close-btn" onclick="closeModal('operationModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>商品コード</label>
                    <input type="text" id="opProductCode" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="opProductName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>現在庫</label>
                    <input type="text" id="opCurrentStock" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>数量</label>
                    <input type="number" id="opQuantity" placeholder="0" min="0" value="1" inputmode="numeric" pattern="\d*">
                </div>
                <div id="reasonSection" class="form-group">
                    <label>使用理由</label>
                    <select id="opReason">
                        <option value="">選択してください</option>
                        <option value="regular">定期交換</option>
                        <option value="unexpected">突発交換</option>
                                            <option value="other">その他</option>
                    </select>
                </div>
                <div id="detailReasonSection" class="form-group hidden" style="display:none;">
                    <label>詳細理由</label>
                    <select id="opDetailReason">
                        <option value="">選択してください</option>
                        <option value="broken">破損</option>
                        <option value="lost">紛失</option>
                        <option value="worn">摩耗</option>
                        <option value="deteriorated">劣化</option>
                    </select>
                </div>
                <div id="otherCommentSection" class="form-group hidden" style="display:none;">
                    <label>コメント</label>
                    <textarea id="opOtherComment" placeholder="使用理由の詳細を入力してください..." style="min-height: 60px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('operationModal')">キャンセル</button>
                <button class="btn btn-primary" id="opConfirmBtn">確定</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 納入操作 -->
    <div class="modal-overlay" id="receiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">納入</h2>
                <button class="modal-close-btn" onclick="closeModal('receiveModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>商品コード</label>
                    <input type="text" id="rcProductCode" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="rcProductName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>現在庫</label>
                    <input type="text" id="rcCurrentStock" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>数量</label>
                    <input type="number" id="rcQuantity" placeholder="0" min="0" value="1" inputmode="numeric" pattern="\d*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('receiveModal')">キャンセル</button>
                <button class="btn btn-primary" id="rcConfirmBtn">確定</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 発注依頼 -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">発注依頼</h2>
                <button class="modal-close-btn" onclick="closeModal('orderModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>商品コード</label>
                    <input type="text" id="ordProductCode" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="ordProductName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>発注数量</label>
                    <input type="number" id="ordQuantity" placeholder="0" min="1" value="1" inputmode="numeric" pattern="\d*">
                </div>
                <div class="form-group">
                    <label>納入予定日（オプション）</label>
                    <input type="text" id="ordExpectedDate" placeholder="YYYY-MM-DD（任意）">
                </div>
                <div class="form-group">
                    <label>備考</label>
                    <textarea id="ordNote" placeholder="備考があれば記入..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderModal')">キャンセル</button>
                <button class="btn btn-primary" id="ordConfirmBtn">発注依頼</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 商品登録 -->
    <div class="modal-overlay" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="productModalTitle">新規商品登録</h2>
                <button class="modal-close-btn" onclick="closeModal('productModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group-row">
                    <div class="form-group">
                        <label>商品コード <span style="color: #d32f2f;">*</span></label>
                        <input type="text" id="prodCode" placeholder="例: PRD001">
                    </div>
                    <div class="form-group">
                        <label>品名</label>
                        <input type="text" id="prodName" placeholder="商品名">
                    </div>
                    <div class="form-group">
                        <label>メーカー</label>
                        <input type="text" id="prodMaker" placeholder="メーカー名">
                    </div>
                    <div class="form-group">
                        <label>型式（品番）</label>
                        <input type="text" id="prodModel" placeholder="型式 / 品番">
                    </div>
                    <div class="form-group">
                        <label>カテゴリー</label>
                        <input type="text" id="prodCategory" placeholder="カテゴリー名">
                    </div>
                    <div class="form-group">
                        <label>最低在庫数</label>
                        <input type="number" id="prodMinStock" min="0" value="1" inputmode="numeric" pattern="\d*">
                    </div>
                    <div class="form-group">
                        <label>現在庫数</label>
                        <input type="number" id="prodCurrentStock" min="0" value="0" inputmode="numeric" pattern="\d*">
                    </div>
                    <div class="form-group">
                        <label>金額（オプション）</label>
                        <input type="number" id="prodPrice" min="0" placeholder="0" inputmode="numeric" pattern="\d*">
                    </div>
                    <div class="form-group">
                        <label>リードタイム（日数）</label>
                        <input type="number" id="prodLeadTime" min="0" placeholder="0" inputmode="numeric" pattern="\d*">
                    </div>
                    <div class="form-group">
                        <label>交換周期（日数）</label>
                        <input type="number" id="prodCycleDays" min="0" placeholder="定期交換を行わない場合は未入力" inputmode="numeric" pattern="\d*">
                    </div>
                    <div class="form-group form-group-full">
                        <label>備考</label>
                        <textarea id="prodNote" placeholder="備考があれば記入..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('productModal')">キャンセル</button>
                <button class="btn btn-primary" id="prodConfirmBtn">登録</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 棚卸 -->
    <div class="modal-overlay" id="stocktakeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">棚卸</h2>
                <button class="modal-close-btn" onclick="closeModal('stocktakeModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>商品コード</label>
                    <input type="text" id="stProductCode" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="stProductName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>システム上の在庫数</label>
                    <input type="text" id="stSystemStock" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>実在庫数</label>
                    <input type="number" id="stActualStock" placeholder="0" min="0" inputmode="numeric" pattern="\d*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="skipStocktakeItem()">スキップ</button>
                <button class="btn btn-primary" id="stConfirmBtn">次へ</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 履歴編集 -->
    <div class="modal-overlay" id="editHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">履歴を編集</h2>
                <button class="modal-close-btn" onclick="closeModal('editHistoryModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>日時</label>
                    <input type="text" id="ehDateTime" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>商品名</label>
                    <input type="text" id="ehProductName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>数量</label>
                    <input type="number" id="ehQuantity" min="0" inputmode="numeric" pattern="\d*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editHistoryModal')">キャンセル</button>
                <button class="btn btn-primary" id="ehConfirmBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 隠し入力: CSVインポート -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">

    <script>
        // ========================================
        // グローバル状態管理
        // ========================================
        // ローカルストレージ不可時の フォールバック（メモリキャッシュ）
        let STORAGE_CACHE = {};
        let STORAGE_AVAILABLE = true;
        
        // localStorage 利用可能か確認
        try {
            const test = '__test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
        } catch (e) {
            STORAGE_AVAILABLE = false;
            console.warn('localStorage is not available, using memory cache');
        }
        
        const STATE = {
            products: [],
            history: [],
            orders: [],
            categories: [],
            makers: [],
            currentScreen: 'inventory',
            currentFilter: {
                category: null,
                search: '',
                lowStockOnly: false
            },
            stocktakeMode: false,
            stocktakeIndex: 0,
            stocktakeResults: [],
            calendarYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth()
        };

        // ========================================
        // LocalStorage 管理
        // ========================================
        const STORAGE_KEYS = {
            PRODUCTS: 'inventory_products',
            HISTORY: 'inventory_history',
            ORDERS: 'inventory_orders',
            CATEGORIES: 'inventory_categories',
            MAKERS: 'inventory_makers',
            STOCKTAKE_PROGRESS: 'inventory_stocktake_progress'
        };

        // ========================================
        // 初期化
        // ========================================
        function initApp() {
            loadAllData();
            setupEventListeners();
            renderCurrentScreen();
        }

        function loadAllData() {
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            STATE.history = loadFromStorage(STORAGE_KEYS.HISTORY, []);
            STATE.orders = loadFromStorage(STORAGE_KEYS.ORDERS, []);
            STATE.categories = loadFromStorage(STORAGE_KEYS.CATEGORIES, []);
            STATE.makers = loadFromStorage(STORAGE_KEYS.MAKERS, []);
        }

        function loadFromStorage(key, defaultValue) {
            try {
                // localStorage が利用可能ならそこから、なければメモリキャッシュから取得
                if (STORAGE_AVAILABLE) {
                    const data = localStorage.getItem(key);
                    if (data) return JSON.parse(data);
                }
                // フォールバック: メモリキャッシュから取得
                if (STORAGE_CACHE[key]) return JSON.parse(STORAGE_CACHE[key]);
                return defaultValue;
            } catch (e) {
                console.error('Storage load error:', key, e);
                return defaultValue;
            }
        }

        function saveToStorage(key, data) {
            try {
                const jsonData = JSON.stringify(data);
                // localStorage が利用可能なら保存
                if (STORAGE_AVAILABLE) {
                    localStorage.setItem(key, jsonData);
                } else {
                    // フォールバック: メモリキャッシュに保存
                    STORAGE_CACHE[key] = jsonData;
                }
            } catch (e) {
                console.error('Storage save error:', key, e);
                // localStorage 容量不足時はメモリキャッシュに フォールバック
                try {
                    STORAGE_CACHE[key] = JSON.stringify(data);
                } catch (e2) {
                    alert('データ保存に失敗しました。ストレージ容量をご確認ください。');
                }
            }
        }

        // ========================================
        // イベントリスナー設定
        // ========================================
        function setupEventListeners() {
            // ナビゲーション
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const screen = e.target.dataset.screen;
                    switchScreen(screen);
                });
            });

            // 在庫操作画面
            document.getElementById('inventorySearch').addEventListener('input', (e) => {
                STATE.currentFilter.search = e.target.value;
                renderInventoryList();
            });

            document.getElementById('categoryToggleBtn').addEventListener('click', () => {
                const filterDiv = document.getElementById('categoryFilter');
                const isVisible = filterDiv.style.display !== 'none';
                if (isVisible) {
                    filterDiv.style.display = 'none';
                } else {
                    filterDiv.style.display = 'flex';
                    renderCategoryFilter();
                }
            });

            document.getElementById('categoryFilter').addEventListener('click', (e) => {
                if (e.target.classList.contains('chip')) {
                    const cat = e.target.dataset.category;
                    document.querySelectorAll('#categoryFilter .chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    STATE.currentFilter.category = cat;
                    document.getElementById('categoryFilter').style.display = 'none';
                    renderInventoryList();
                }
            });

            // 履歴画面
            document.getElementById('historySearch').addEventListener('input', (e) => {
                renderHistoryList(e.target.value);
            });

            document.getElementById('historyFilter').addEventListener('click', (e) => {
                if (e.target.classList.contains('chip')) {
                    document.querySelectorAll('#historyFilter .chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    renderHistoryList('', filter);
                }
            });

            // 商品管理画面
            document.getElementById('newProductBtn').addEventListener('click', () => {
                openProductModal();
            });

            document.getElementById('stocktakeBtn').addEventListener('click', () => {
                startStocktake();
            });

            document.getElementById('masterSearch').addEventListener('input', (e) => {
                renderMasterList(e.target.value);
            });

            // 商品登録モーダル
            document.getElementById('prodConfirmBtn').addEventListener('click', saveProduct);

            // 使用・納入・発注確定ボタン
            document.getElementById('opConfirmBtn').addEventListener('click', saveUseOperation);
            document.getElementById('rcConfirmBtn').addEventListener('click', saveReceiveOperation);
            document.getElementById('ordConfirmBtn').addEventListener('click', saveOrderRequest);

                        // 使用理由の変更時にコメント欄や詳細理由欄の表示を制御
                        document.getElementById('opReason').addEventListener('change', (e) => {
                            const reason = e.target.value;
                            const detailSection = document.getElementById('detailReasonSection');
                            const commentSection = document.getElementById('otherCommentSection');

                            if (reason === 'unexpected') {
                                detailSection.style.display = 'block';
                                commentSection.style.display = 'none';
                                document.getElementById('opOtherComment').value = '';
                            } else if (reason === 'other') {
                                detailSection.style.display = 'none';
                                commentSection.style.display = 'block';
                                document.getElementById('opDetailReason').value = '';
                            } else {
                                detailSection.style.display = 'none';
                                commentSection.style.display = 'none';
                                document.getElementById('opDetailReason').value = '';
                                document.getElementById('opOtherComment').value = '';
                            }
                        });
            document.getElementById('stConfirmBtn').addEventListener('click', saveStocktakeItem);
            document.getElementById('ehConfirmBtn').addEventListener('click', saveEditHistory);

            // 棚卸モーダルの入力フォーカス時にテンキーで押し上げられる問題を防ぐ
            const stInput = document.getElementById('stActualStock');
            if (stInput) {
                stInput.addEventListener('focus', () => {
                    document.body.classList.add('keyboard-open-stocktake');
                    // 少し遅延してスクロール位置を調整
                    setTimeout(() => {
                        const modal = document.querySelector('#stocktakeModal .modal-content');
                        if (modal) modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
                stInput.addEventListener('blur', () => {
                    document.body.classList.remove('keyboard-open-stocktake');
                });
            }

            // 使用理由の変更監視
            document.getElementById('opReason').addEventListener('change', (e) => {
                const detailSection = document.getElementById('detailReasonSection');
                if (e.target.value === 'unexpected') {
                    detailSection.style.display = '';
                } else {
                    detailSection.style.display = 'none';
                    document.getElementById('opDetailReason').value = '';
                }
            });

            // エクスポート・インポート
            document.getElementById('exportMasterBtn').addEventListener('click', () => exportData('master'));
            document.getElementById('importMasterBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
            document.getElementById('exportHistoryBtn').addEventListener('click', () => exportData('history'));
            document.getElementById('backupBtn').addEventListener('click', backupAllData);
            document.getElementById('restoreBtn').addEventListener('click', restoreData);
            document.getElementById('initializeBtn').addEventListener('click', () => {
                if (!confirm('アプリの全データを初期化します。よろしいですか？\n（この操作は元に戻せません）')) return;
                resetAllData();
            });

            document.getElementById('csvFileInput').addEventListener('change', handleCsvImport);

            // モーダル背景クリック時のクローズ
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // ========================================
        // 画面切り替え
        // ========================================
        function switchScreen(screenName) {
            const prevScreen = STATE.currentScreen;
            // ナビゲーション更新
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.screen === screenName) {
                    tab.classList.add('active');
                }
            });

            // コンテンツ更新
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById(screenName).classList.add('active');

            STATE.currentScreen = screenName;

            // 画面固有の初期化
            if (screenName === 'inventory') {
                renderCategoryFilter();
                renderInventoryList();
            } else if (screenName === 'master') {
                renderMasterList();
            } else if (screenName === 'calendar') {
                renderCalendarScreen();
            }

            // カレンダー画面以外ではカレンダー領域を明示的に非表示・クリアする
            const calArea = document.getElementById('calendar');
            const cal = document.getElementById('calendarContainer');
            const sched = document.getElementById('scheduleList');
            if (calArea) {
                if (screenName === 'calendar') {
                    calArea.style.display = 'flex';
                    if (typeof renderCalendarScreen === 'function') renderCalendarScreen();
                } else {
                    // 完全に非表示にして中身をクリア
                    calArea.style.display = 'none';
                    if (cal) cal.innerHTML = '';
                    if (sched) sched.innerHTML = '';
                }
            }
        }

        // 在庫不足フィルタの切り替え
        function toggleLowStockFilter() {
            STATE.currentFilter.lowStockOnly = !STATE.currentFilter.lowStockOnly;
            const btn = document.getElementById('lowStockBtn');
            if (STATE.currentFilter.lowStockOnly) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            renderInventoryList();
        }

        // カレンダーの前月・次月ボタン
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            STATE.calendarMonth--;
            if (STATE.calendarMonth < 0) {
                STATE.calendarMonth = 11;
                STATE.calendarYear--;
            }
            renderCalendarScreen();
        });

        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            STATE.calendarMonth++;
            if (STATE.calendarMonth > 11) {
                STATE.calendarMonth = 0;
                STATE.calendarYear++;
            }
            renderCalendarScreen();
        });

        // カテゴリーカラーパレット
        const categoryColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#A8E6CF',
            '#FFD3B6', '#FFAAA5', '#87CEEB', '#90EE90', '#FFB6C1'
        ];

        function getCategoryColor(category) {
            if (!category) return '#CCCCCC';
            const hash = category.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return categoryColors[hash % categoryColors.length];
        }

        // ========================================
        // 在庫操作画面
        // ========================================
        function renderCategoryFilter() {
            // 常に最新データから開始
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            STATE.categories = loadFromStorage(STORAGE_KEYS.CATEGORIES, []);
            
            const filterContainer = document.getElementById('categoryFilter');
            filterContainer.innerHTML = '';
            filterContainer.style.flexDirection = 'column';
            filterContainer.style.position = 'absolute';
            filterContainer.style.top = 'calc(100% + 8px)';
            filterContainer.style.left = '16px';
            filterContainer.style.right = '16px';
            filterContainer.style.backgroundColor = 'white';
            filterContainer.style.border = '1px solid #d0d0d0';
            filterContainer.style.borderRadius = '6px';
            filterContainer.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            filterContainer.style.zIndex = '1000';
            filterContainer.style.maxHeight = '300px';
            filterContainer.style.overflowY = 'auto';
            filterContainer.style.width = 'auto';

            const categories = [...new Set(STATE.products.map(p => p.category))].filter(Boolean).sort();

            categories.forEach(cat => {
                const chip = document.createElement('button');
                chip.className = 'chip';
                chip.textContent = cat;
                chip.dataset.category = cat;
                const catColor = getCategoryColor(cat);
                chip.style.backgroundColor = catColor;
                chip.style.color = 'white';
                chip.style.borderColor = catColor;
                chip.style.width = '100%';
                chip.style.margin = '0';
                chip.style.borderRadius = '0';
                chip.style.padding = '12px';
                chip.style.border = 'none';
                chip.style.borderBottom = '1px solid #f0f0f0';
                chip.style.textAlign = 'left';
                if (STATE.currentFilter.category === cat) {
                    chip.classList.add('active');
                }
                filterContainer.appendChild(chip);
            });
        }

        function renderInventoryList() {
            // 常に最新データから開始
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            STATE.history = loadFromStorage(STORAGE_KEYS.HISTORY, []);
            STATE.orders = loadFromStorage(STORAGE_KEYS.ORDERS, []);
            
            const listContainer = document.getElementById('inventoryList');
            const searchTerm = STATE.currentFilter.search.toLowerCase();
            const categoryFilter = STATE.currentFilter.category;
            const lowStockOnly = STATE.currentFilter.lowStockOnly;

            let filtered = STATE.products.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(searchTerm) ||
                                   p.code.toLowerCase().includes(searchTerm);
                const matchCategory = !categoryFilter || p.category === categoryFilter;
                const isLow = p.currentStock <= p.minStock;
                const matchLowStock = !lowStockOnly || isLow;
                return matchSearch && matchCategory && matchLowStock && !p.deleted;
            });

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="list-empty">商品が見つかりません</div>';
                return;
            }

            listContainer.innerHTML = filtered.map(product => {
                const isLow = product.currentStock <= product.minStock;
                const hasOrder = STATE.orders.find(o => o.productCode === product.code && o.status === '依頼中');
                
                let alertClass = '';
                let statusBadge = '';
                
                if (isLow) {
                    alertClass = 'alert-low';
                    statusBadge = '<span class="stock-badge low">在庫不足</span>';
                } else if (hasOrder) {
                    alertClass = 'alert-ordering';
                    statusBadge = '<span class="stock-badge ordering">発注中</span>';
                } else {
                    statusBadge = '<span class="stock-badge normal">正常</span>';
                }

                const categoryBadge = product.category ? `<span class="category-badge" style="background: ${getCategoryColor(product.category)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">${escapeHtml(product.category)}</span>` : '-';
                return `
                    <div class="list-item ${alertClass}" style="border-bottom: 1px solid #e0e0e0; padding: 12px 16px;">
                        <div class="list-item-header">
                            <div class="list-item-title">${escapeHtml(product.name)}</div>
                            ${statusBadge}
                        </div>
                        <div class="list-item-text">コード: ${escapeHtml(product.code)}</div>
                        <div class="list-item-text">カテゴリー: ${categoryBadge}</div>
                        <div class="list-item-text">在庫: <strong>${product.currentStock}</strong> 個 (最低: ${product.minStock} 個)</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-small btn-primary" onclick="openOperationModal('use', '${product.code}')">使用</button>
                            <button class="btn btn-small btn-primary" onclick="openOperationModal('receive', '${product.code}')">納入</button>
                            <button class="btn btn-small btn-secondary" onclick="openOrderModal('${product.code}')">発注</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // 使用・納入・発注モーダル
        // ========================================
        function openOperationModal(type, productCode) {
            // 最新のマスターをリロード（新規登録直後など）
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            
            const product = STATE.products.find(p => p && p.code && (p.code.toString().trim() === productCode.toString().trim()));
            if (!type) return;
            if (!product) {
                alert('商品が見つかりません。マスターで商品を確認してください。\nコード: ' + productCode + '\n登録済み商品数: ' + STATE.products.length);
                return;
            }

            if (type === 'use') {
                document.getElementById('operationModal').classList.add('show');
                lockBodyScroll();
                document.getElementById('operationTitle').textContent = '使用';
                document.getElementById('opProductCode').value = product.code || '';
                document.getElementById('opProductName').value = product.name || '';
                document.getElementById('opCurrentStock').value = (product.currentStock !== undefined) ? product.currentStock : '';
                document.getElementById('opQuantity').value = '1';
                document.getElementById('opReason').value = '';
                document.getElementById('opDetailReason').value = '';
                document.getElementById('detailReasonSection').style.display = 'none';
            } else if (type === 'receive') {
                document.getElementById('receiveModal').classList.add('show');
                lockBodyScroll();
                document.getElementById('rcProductCode').value = product.code || '';
                document.getElementById('rcProductName').value = product.name || '';
                document.getElementById('rcCurrentStock').value = (product.currentStock !== undefined) ? product.currentStock : '';
                document.getElementById('rcQuantity').value = '1';
            }
        }

        function openOrderModal(productCode) {
            // 最新のマスターをリロード
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            
            const product = STATE.products.find(p => p && p.code && (p.code.toString().trim() === productCode.toString().trim()));
            if (!product) {
                alert('商品が見つかりません。マスターで商品を確認してください。\nコード: ' + productCode + '\n登録済み商品数: ' + STATE.products.length);
                return;
            }

            document.getElementById('orderModal').classList.add('show');
            lockBodyScroll();
            document.getElementById('ordProductCode').value = product.code || '';
            document.getElementById('ordProductName').value = product.name || '';
            document.getElementById('ordQuantity').value = '1';
            document.getElementById('ordExpectedDate').value = '';
            document.getElementById('ordNote').value = '';
        }

        function saveUseOperation() {
            const code = document.getElementById('opProductCode').value;
            const quantity = parseInt(document.getElementById('opQuantity').value) || 0;
            const reason = document.getElementById('opReason').value;
            const detailReason = document.getElementById('opDetailReason').value;
            const otherComment = document.getElementById('opOtherComment').value;

            if (!code || quantity <= 0 || !reason) {
                alert('必須項目を入力してください');

                            // その他の場合はコメント必須
                            if (reason === 'other' && !otherComment.trim()) {
                                alert('コメントを入力してください');
                                return;
                            }
                return;
            }

            const product = STATE.products.find(p => p.code === code);
            if (!product) return;

            const newStock = product.currentStock - quantity;
            product.currentStock = newStock;

            addHistory({
                datetime: new Date().toISOString(),
                productCode: code,
                productName: product.name,
                category: product.category,
                type: 'use',
                quantity: quantity,
                afterStock: newStock,
                reason: reason,
                detailReason: reason === 'unexpected' ? detailReason : (reason === 'other' ? otherComment : null)
            });

            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
            saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);

            closeModal('operationModal');
            renderInventoryList();
            alert('使用を記録しました');
        }

        function saveReceiveOperation() {
            const code = document.getElementById('rcProductCode').value;
            const quantity = parseInt(document.getElementById('rcQuantity').value) || 0;

            if (!code || quantity <= 0) {
                alert('必須項目を入力してください');
                return;
            }

            const product = STATE.products.find(p => p.code === code);
            if (!product) return;

            const newStock = product.currentStock + quantity;
            product.currentStock = newStock;

            addHistory({
                datetime: new Date().toISOString(),
                productCode: code,
                productName: product.name,
                category: product.category,
                type: 'receive',
                quantity: quantity,
                afterStock: newStock,
                reason: null,
                detailReason: null
            });

            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
            saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);

            closeModal('receiveModal');
            renderInventoryList();
            alert('納入を記録しました');
        }

        function saveOrderRequest() {
            const code = document.getElementById('ordProductCode').value;
            const quantity = parseInt(document.getElementById('ordQuantity').value) || 0;
            const expectedDateRaw = (document.getElementById('ordExpectedDate').value || '').trim();
            const note = document.getElementById('ordNote').value;

            // 納入予定日が入力されている場合は YYYY-MM-DD 形式かつ実在する日付かを検証
            if (expectedDateRaw) {
                const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!isoRegex.test(expectedDateRaw)) {
                    alert('納入予定日は YYYY-MM-DD の形式で入力してください');
                    document.getElementById('ordExpectedDate').focus();
                    return;
                }
                const dt = new Date(expectedDateRaw);
                if (isNaN(dt.getTime())) {
                    alert('納入予定日に正しい日付を入力してください');
                    document.getElementById('ordExpectedDate').focus();
                    return;
                }
            }
            const expectedDate = expectedDateRaw || '';

            if (!code || quantity <= 0) {
                alert('必須項目を入力してください');
                return;
            }

            const existingOrder = STATE.orders.find(o => o.productCode === code && o.status === '依頼中');
            if (existingOrder) {
                alert('この商品は既に発注依頼中です');
                return;
            }

            STATE.orders.push({
                id: Date.now().toString(),
                productCode: code,
                quantity: quantity,
                orderDate: new Date().toISOString().split('T')[0],
                expectedDate: expectedDate,
                status: '依頼中',
                note: note
            });

            saveToStorage(STORAGE_KEYS.ORDERS, STATE.orders);

            closeModal('orderModal');
            renderInventoryList();
            alert('発注依頼を登録しました');
        }

        // ========================================
        // 操作履歴画面
        // ========================================
        function renderHistoryList(searchTerm = '', typeFilter = 'all') {
            const listContainer = document.getElementById('historyList');
            const searchLower = searchTerm.toLowerCase();

            let filtered = STATE.history.slice().reverse();

            if (searchTerm) {
                filtered = filtered.filter(h => 
                    h.productName.toLowerCase().includes(searchLower) ||
                    h.productCode.toLowerCase().includes(searchLower) ||
                    (h.category && h.category.toLowerCase().includes(searchLower))
                );
            }

            if (typeFilter !== 'all') {
                filtered = filtered.filter(h => h.type === typeFilter);
            }

            filtered = filtered.slice(0, 1000);

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="list-empty">履歴がありません</div>';
                return;
            }

            listContainer.innerHTML = filtered.map((item, index) => {
                const datetime = new Date(item.datetime);
                const dateStr = datetime.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const typeLabel = {
                    'use': '使用',
                    'receive': '納入',
                    'stocktake': '棚卸',
                    'modify': '修正'
                }[item.type] || item.type;

                const reasonText = item.reason ? `(${item.reason})` : '';
                const detailText = item.detailReason ? `(${item.detailReason})` : '';
                const modifiedBadge = item.modified ? '<span class="modified-badge">修正済</span>' : '';

                return `
                    <div class="list-item" style="border-bottom: 1px solid #e0e0e0;">
                        <div class="list-item-header">
                            <div>
                                <div class="list-item-text"><strong>${escapeHtml(item.productName)}</strong> ${modifiedBadge}</div>
                                <div class="list-item-text">${dateStr}</div>
                            </div>
                            <div class="list-item-badge">${typeLabel}</div>
                        </div>
                        <div class="list-item-text">コード: ${escapeHtml(item.productCode)}</div>
                        <div class="list-item-text">カテゴリー: ${escapeHtml(item.category || '-')}</div>
                        <div class="list-item-text">数量: ${item.quantity} 個 → 在庫: ${item.afterStock} 個</div>
                        ${item.reason ? `<div class="list-item-text">理由: ${item.reason} ${detailText}</div>` : ''}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="openEditHistoryModal(${STATE.history.indexOf(item)})">編集</button>
                            <button class="btn btn-small btn-danger" onclick="deleteHistory(${STATE.history.indexOf(item)})">削除</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addHistory(item) {
            STATE.history.push({
                ...item,
                id: Date.now().toString(),
                modified: false,
                modifiedDate: null
            });
        }

        function openEditHistoryModal(historyIndex) {
            const item = STATE.history[historyIndex];
            if (!item) return;

            const datetime = new Date(item.datetime);
            const dateStr = datetime.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('editHistoryModal').classList.add('show');
            lockBodyScroll();
            document.getElementById('ehDateTime').value = dateStr;
            document.getElementById('ehProductName').value = item.productName;
            document.getElementById('ehQuantity').value = item.quantity;
            document.getElementById('ehConfirmBtn').dataset.index = historyIndex;
        }

        function saveEditHistory() {
            const index = parseInt(document.getElementById('ehConfirmBtn').dataset.index);
            const newQuantity = parseInt(document.getElementById('ehQuantity').value) || 0;

            const item = STATE.history[index];
            if (!item || newQuantity < 0) {
                alert('数値が不正です');
                return;
            }

            const quantityDiff = newQuantity - item.quantity;
            item.quantity = newQuantity;
            item.modified = true;
            item.modifiedDate = new Date().toISOString();

            // 在庫を再計算
            const product = STATE.products.find(p => p.code === item.productCode);
            if (product) {
                if (item.type === 'use') {
                    product.currentStock += quantityDiff;
                } else if (item.type === 'receive') {
                    product.currentStock -= quantityDiff;
                }
            }

            saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);
            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);

            closeModal('editHistoryModal');
            renderHistoryList();
            alert('履歴を更新しました');
        }

        function deleteHistory(index) {
            if (!confirm('この履歴を削除しますか？')) return;

            const item = STATE.history[index];
            const product = STATE.products.find(p => p.code === item.productCode);

            // 在庫を逆算して戻す
            if (product) {
                if (item.type === 'use') {
                    product.currentStock += item.quantity;
                } else if (item.type === 'receive') {
                    product.currentStock -= item.quantity;
                }
            }

            STATE.history.splice(index, 1);

            saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);
            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
            renderHistoryList();
            alert('履歴を削除しました');
        }

        // ========================================
        // 商品管理・棚卸画面
        // ========================================
        function renderMasterList(searchTerm = '') {
            // 常に最新データから開始
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            
            const listContainer = document.getElementById('masterList');
            const searchLower = searchTerm.toLowerCase();

            let filtered = STATE.products.filter(p => {
                if (p.deleted) return false;
                if (!searchTerm) return true;
                return p.name.toLowerCase().includes(searchLower) ||
                       p.code.toLowerCase().includes(searchLower);
            });

            if (filtered.length === 0) {
                listContainer.innerHTML = '<div class="list-empty">商品がありません</div>';
                return;
            }

            listContainer.innerHTML = filtered.map(product => {
                const lastStocktakeDate = product.lastStocktakeDate ? 
                    new Date(product.lastStocktakeDate).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }) : '-';
                
                const categoryBadge = product.category ? `<span class="category-badge" style="background: ${getCategoryColor(product.category)}; color: white; padding: 3px 6px; border-radius: 3px; font-size: 11px; font-weight: 600; margin-left: 4px;">${escapeHtml(product.category)}</span>` : '';

                return `
                    <div class="list-item" style="border-bottom: 1px solid #e0e0e0;">
                        <div class="list-item-header">
                            <div class="list-item-title">${escapeHtml(product.name)}</div>
                            <button class="btn btn-small btn-secondary" onclick="editProduct('${product.code}')">編集</button>
                        </div>
                        <div class="list-item-text">コード: ${escapeHtml(product.code)}</div>
                        <div class="list-item-text">メーカー: ${escapeHtml(product.maker || '-')}</div>
                        <div class="list-item-text">型式: ${escapeHtml(product.model || '-')}</div>
                        <div class="list-item-text">カテゴリー: ${categoryBadge}</div>
                        <div class="list-item-text">在庫: ${product.currentStock} / 最低: ${product.minStock}</div>
                        <div class="list-item-text">交換周期: ${product.cycleDays || '-'} 日</div>
                        <div class="list-item-text">最終棚卸: ${lastStocktakeDate}</div>
                    </div>
                `;
            }).join('');
        }

        function openProductModal(productCode = null) {
            // 最新のマスターデータをリロード
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);
            
            // === デバッグ情報を alert で表示 ===
            if (productCode) {
                alert('【デバッグ情報】\n' +
                    'productCode: ' + productCode + '\n' +
                    'STATE.products.length: ' + STATE.products.length + '\n' +
                    'STATE.products: ' + JSON.stringify(STATE.products.slice(0, 2)) + '\n' +
                    'STORAGE_AVAILABLE: ' + STORAGE_AVAILABLE + '\n' +
                    'STORAGE_CACHE keys: ' + Object.keys(STORAGE_CACHE).join(', '));
            }
            
            const modal = document.getElementById('productModal');
            if (!modal) {
                alert('ERROR: productModal element not found');
                return;
            }
            
            // フォーム要素を取得して存在確認
            const fields = {
                prodCode: document.getElementById('prodCode'),
                prodName: document.getElementById('prodName'),
                prodMaker: document.getElementById('prodMaker'),
                prodModel: document.getElementById('prodModel'),
                prodCategory: document.getElementById('prodCategory'),
                prodMinStock: document.getElementById('prodMinStock'),
                prodCurrentStock: document.getElementById('prodCurrentStock'),
                prodPrice: document.getElementById('prodPrice'),
                prodLeadTime: document.getElementById('prodLeadTime'),
                prodCycleDays: document.getElementById('prodCycleDays'),
                prodNote: document.getElementById('prodNote'),
                prodConfirmBtn: document.getElementById('prodConfirmBtn'),
                productModalTitle: document.getElementById('productModalTitle')
            };
            
            // 要素が見つからない場合はアラート
            const missingFields = Object.entries(fields).filter(([_, el]) => !el).map(([name]) => name);
            if (missingFields.length > 0) {
                alert('ERROR: 要素が見つかりません: ' + missingFields.join(', '));
                return;
            }
            
            // モーダル表示
            modal.classList.add('show');
            lockBodyScroll();

            if (productCode) {
                // 商品検索（少し厳格にチェック）
                const product = STATE.products.find(p => {
                    return p && p.code && (p.code.toString().trim() === productCode.toString().trim());
                });
                
                if (product) {
                    alert('【商品検索成功】\n商品: ' + product.name + '\nコード: ' + product.code);
                    
                    fields.productModalTitle.textContent = '商品編集';
                    fields.prodCode.value = product.code || '';
                    fields.prodCode.readOnly = false;
                    fields.prodCode.style.background = 'white';
                    fields.prodName.value = product.name || '';
                    fields.prodMaker.value = product.maker || '';
                    fields.prodModel.value = product.model || '';
                    fields.prodCategory.value = product.category || '';
                    fields.prodMinStock.value = product.minStock || 1;
                    fields.prodCurrentStock.value = product.currentStock || 0;
                    fields.prodPrice.value = product.price || '';
                    fields.prodLeadTime.value = product.leadTime || '';
                    fields.prodCycleDays.value = product.cycleDays || '';
                    fields.prodNote.value = product.note || '';
                    fields.prodConfirmBtn.dataset.editCode = productCode;
                } else {
                    // デバッグ情報を表示
                    const debugMsg = '【商品検索失敗】\nコード: ' + productCode + '\n登録済み商品数: ' + STATE.products.length + '\n' +
                        (STATE.products.length > 0 ? '登録済みコード:\n' + STATE.products.map(p => '- ' + p.code).join('\n') : '(登録済み商品なし)');
                    alert(debugMsg);
                    modal.classList.remove('show');
                    unlockBodyScroll();
                }
            } else {
                fields.productModalTitle.textContent = '新規商品登録';
                fields.prodCode.value = '';
                fields.prodCode.readOnly = false;
                fields.prodCode.style.background = 'white';
                fields.prodName.value = '';
                fields.prodMaker.value = '';
                fields.prodModel.value = '';
                fields.prodCategory.value = '';
                fields.prodMinStock.value = '1';
                fields.prodCurrentStock.value = '0';
                fields.prodPrice.value = '';
                fields.prodLeadTime.value = '';
                fields.prodCycleDays.value = '';
                fields.prodNote.value = '';
                fields.prodConfirmBtn.dataset.editCode = '';
            }
        }

        function editProduct(productCode) {
            openProductModal(productCode);
        }

        function saveProduct() {
            const code = document.getElementById('prodCode').value.trim();
            const name = document.getElementById('prodName').value.trim();
            const maker = document.getElementById('prodMaker').value.trim();
            const model = document.getElementById('prodModel').value.trim();
            const category = document.getElementById('prodCategory').value.trim();
            const minStock = parseInt(document.getElementById('prodMinStock').value) || 1;
            const currentStock = parseInt(document.getElementById('prodCurrentStock').value) || 0;
            const price = parseInt(document.getElementById('prodPrice').value) || 0;
            const leadTime = parseInt(document.getElementById('prodLeadTime').value) || 0;
            const cycleDays = document.getElementById('prodCycleDays').value ? 
                parseInt(document.getElementById('prodCycleDays').value) : null;
            const note = document.getElementById('prodNote').value.trim();

            if (!code) {
                alert('商品コードは必須です');
                return;
            }

            const editCode = document.getElementById('prodConfirmBtn').dataset.editCode;

            if (!editCode) {
                // 新規登録
                if (STATE.products.find(p => p.code === code && !p.deleted)) {
                    alert('この商品コードは既に登録されています');
                    return;
                }

                STATE.products.push({
                    code: code,
                    name: name,
                    maker: maker,
                    model: model,
                    category: category,
                    minStock: minStock,
                    currentStock: currentStock,
                    price: price,
                    leadTime: leadTime,
                    cycleDays: cycleDays,
                    note: note,
                    createdDate: new Date().toISOString(),
                    lastStocktakeDate: null,
                    deleted: false
                });

                // マスターデータに追加
                if (category && !STATE.categories.includes(category)) {
                    STATE.categories.push(category);
                    saveToStorage(STORAGE_KEYS.CATEGORIES, STATE.categories);
                }
                if (maker && !STATE.makers.includes(maker)) {
                    STATE.makers.push(maker);
                    saveToStorage(STORAGE_KEYS.MAKERS, STATE.makers);
                }
            } else {
                // 編集
                const product = STATE.products.find(p => p.code === editCode);
                if (product) {
                    // 商品コードが変更される可能性があるため事前チェック
                    if (code !== editCode) {
                        // 新コードが既存の他商品に使われていないか確認
                        const dup = STATE.products.find(p => p.code === code && !p.deleted);
                        if (dup) {
                            alert('入力された商品コードは既に使用されています。別のコードを指定してください。');
                            return;
                        }
                        // 参照更新（履歴・発注・棚卸結果）
                        STATE.history.forEach(h => {
                            if (h.productCode === editCode) h.productCode = code;
                        });
                        STATE.orders.forEach(o => {
                            if (o.productCode === editCode) o.productCode = code;
                        });
                        if (Array.isArray(STATE.stocktakeResults)) {
                            STATE.stocktakeResults.forEach(r => {
                                if (r.code === editCode) r.code = code;
                            });
                        }
                        product.code = code;
                    }

                    product.name = name;
                    product.maker = maker;
                    product.model = model;
                    product.category = category;
                    product.minStock = minStock;
                    product.currentStock = currentStock;
                    product.price = price;
                    product.leadTime = leadTime;
                    product.cycleDays = cycleDays;
                    product.note = note;

                    // マスターデータに追加
                    if (category && !STATE.categories.includes(category)) {
                        STATE.categories.push(category);
                        saveToStorage(STORAGE_KEYS.CATEGORIES, STATE.categories);
                    }
                    if (maker && !STATE.makers.includes(maker)) {
                        STATE.makers.push(maker);
                        saveToStorage(STORAGE_KEYS.MAKERS, STATE.makers);
                    }
                }
            }

            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
            closeModal('productModal');
            renderMasterList();
            renderCategoryFilter();
            renderInventoryList();
            alert('商品情報を保存しました');
        }

        function startStocktake() {
            // 最新のマスターをストレージから再読み込みしてから開始
            STATE.products = loadFromStorage(STORAGE_KEYS.PRODUCTS, []);

            if (STATE.products.filter(p => !p.deleted).length === 0) {
                alert('登録済み商品がありません');
                return;
            }

            // 既に途中の進捗があれば復元して再開（途中保存あり）
            const saved = loadFromStorage(STORAGE_KEYS.STOCKTAKE_PROGRESS, null);
            const products = STATE.products.filter(p => !p.deleted);

            STATE.stocktakeMode = true;
            if (saved && typeof saved.index === 'number' && Array.isArray(saved.results)) {
                // インデックスが商品数を超えていれば初期化
                if (saved.index >= products.length) {
                    STATE.stocktakeIndex = 0;
                    STATE.stocktakeResults = [];
                } else {
                    STATE.stocktakeIndex = saved.index;
                    STATE.stocktakeResults = saved.results;
                }
            } else {
                STATE.stocktakeIndex = 0;
                STATE.stocktakeResults = [];
            }

            showNextStocktakeItem();
        }

        function showNextStocktakeItem() {
            const products = STATE.products.filter(p => !p.deleted);

            if (!products || products.length === 0) {
                alert('登録済み商品がありません');
                STATE.stocktakeMode = false;
                return;
            }

            // インデックスが範囲外なら完了扱い
            if (STATE.stocktakeIndex >= products.length) {
                completeStocktake();
                return;
            }

            let product = products[STATE.stocktakeIndex];
            if (!product) {
                // フォールバック: インデックスが不正でも先頭を表示して続行
                product = products[0];
                STATE.stocktakeIndex = 0;
            }

            // 表示
            const modal = document.getElementById('stocktakeModal');
            modal.classList.add('show');
            lockBodyScroll();

            // 表示（値がなければ "-" を入れて空に見えないようにする）
            document.getElementById('stProductCode').value = product.code || '-';
            document.getElementById('stProductName').value = product.name || '-';
            document.getElementById('stSystemStock').value = (typeof product.currentStock !== 'undefined') ? product.currentStock : '-';

            // 前回入力があれば復元（STATE 側の進捗を優先）
            let restoredValue = '';
            if (Array.isArray(STATE.stocktakeResults)) {
                const found = STATE.stocktakeResults.find(r => r.code === product.code);
                if (found && typeof found.actualStock === 'number') restoredValue = String(found.actualStock);
            }
            if (!restoredValue) {
                const prev = loadFromStorage(STORAGE_KEYS.STOCKTAKE_PROGRESS, null);
                if (prev && Array.isArray(prev.results)) {
                    const found2 = prev.results.find(r => r.code === product.code);
                    if (found2 && typeof found2.actualStock === 'number') restoredValue = String(found2.actualStock);
                }
            }

            const stInput = document.getElementById('stActualStock');
            stInput.value = restoredValue;
            // フォーカスを少し遅延して付与（モバイルでキーボードが開かない問題対策）
            setTimeout(() => {
                try {
                    stInput.focus();
                    stInput.click && stInput.click();
                } catch (e) {}
            }, 80);
        }

        function saveStocktakeProgress() {
            try {
                const progress = {
                    index: STATE.stocktakeIndex,
                    results: STATE.stocktakeResults
                };
                saveToStorage(STORAGE_KEYS.STOCKTAKE_PROGRESS, progress);
            } catch (e) {
                console.error('進捗の保存に失敗しました', e);
            }
        }

        function resetStocktakeProgress() {
            try {
                STATE.stocktakeMode = false;
                STATE.stocktakeIndex = 0;
                STATE.stocktakeResults = [];
                try { localStorage.removeItem(STORAGE_KEYS.STOCKTAKE_PROGRESS); } catch (e) {}
                // 閉じている場合は何もしない、開いていれば閉じる
                const modal = document.getElementById('stocktakeModal');
                if (modal && modal.classList.contains('show')) {
                    closeModal('stocktakeModal');
                }
                alert('棚卸の途中保存をリセットしました');
            } catch (e) {
                console.error('リセットに失敗しました', e);
                alert('リセットに失敗しました');
            }
        }

        function resetAllData() {
            try {
                // ストレージキーを全消去
                try { localStorage.removeItem(STORAGE_KEYS.PRODUCTS); } catch (e) {}
                try { localStorage.removeItem(STORAGE_KEYS.HISTORY); } catch (e) {}
                try { localStorage.removeItem(STORAGE_KEYS.ORDERS); } catch (e) {}
                try { localStorage.removeItem(STORAGE_KEYS.CATEGORIES); } catch (e) {}
                try { localStorage.removeItem(STORAGE_KEYS.MAKERS); } catch (e) {}
                try { localStorage.removeItem(STORAGE_KEYS.STOCKTAKE_PROGRESS); } catch (e) {}

                // STATE の初期化
                STATE.products = [];
                STATE.history = [];
                STATE.orders = [];
                STATE.categories = [];
                STATE.makers = [];
                STATE.stocktakeMode = false;
                STATE.stocktakeIndex = 0;
                STATE.stocktakeResults = [];

                // すべてのモーダルを閉じる
                document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
                unlockBodyScroll();

                // 画面更新
                renderMasterList();
                renderInventoryList();
                renderCategoryFilter();
                renderHistoryList();

                alert('全データを初期化しました');
            } catch (e) {
                console.error('初期化に失敗しました', e);
                alert('初期化に失敗しました');
            }
        }

        function skipStocktakeItem() {
            // スキップは記録せず次へ進む
            STATE.stocktakeIndex++;
            saveStocktakeProgress();
            showNextStocktakeItem();
        }

        function saveStocktakeItem() {
            const code = document.getElementById('stProductCode').value;
            const actualStock = document.getElementById('stActualStock').value;

            if (actualStock === '') {
                alert('実在庫数を入力してください。スキップする場合は「スキップ」を押してください。');
                document.getElementById('stActualStock').focus();
                return;
            }

            const actualValue = parseInt(actualStock);
            if (isNaN(actualValue) || actualValue < 0) {
                alert('有効な数値を入力してください');
                return;
            }

            const product = STATE.products.find(p => p.code === code);
            if (product) {
                STATE.stocktakeResults.push({
                    code: code,
                    name: product.name,
                    systemStock: product.currentStock,
                    actualStock: actualValue
                });
            }

            STATE.stocktakeIndex++;
            // 途中結果を保存
            saveStocktakeProgress();
            showNextStocktakeItem();
        }

        function completeStocktake() {
            STATE.stocktakeMode = false;
            const date = new Date();

            STATE.stocktakeResults.forEach(result => {
                const product = STATE.products.find(p => p.code === result.code);
                if (product) {
                    const diff = result.actualStock - result.systemStock;

                    if (diff !== 0) {
                        const type = diff > 0 ? 'receive' : 'use';
                        addHistory({
                            datetime: date.toISOString(),
                            productCode: result.code,
                            productName: result.name,
                            category: product.category,
                            type: 'stocktake',
                            quantity: Math.abs(diff),
                            afterStock: result.actualStock,
                            reason: null,
                            detailReason: null
                        });
                    }

                    product.currentStock = result.actualStock;
                    product.lastStocktakeDate = date.toISOString().split('T')[0];
                }
            });

            saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
            saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);

            // 完了したら進捗を削除
            try { localStorage.removeItem(STORAGE_KEYS.STOCKTAKE_PROGRESS); } catch (e) {}

            closeModal('stocktakeModal');
            renderMasterList();
            renderInventoryList();
            alert(`棚卸が完了しました (${STATE.stocktakeResults.length}件)`);

            STATE.stocktakeResults = [];
        }

        // ========================================
        // 交換周期カレンダー
        // ========================================
        function renderCalendarScreen() {
            renderMonthCalendar();
            renderScheduleList();
        }

        function renderMonthCalendar() {
            const container = document.getElementById('calendarContainer');
            const today = new Date();
            const year = STATE.calendarYear;
            const month = STATE.calendarMonth;

            // 月表示を更新
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            document.getElementById('monthDisplay').textContent = `${year}年 ${monthNames[month]}`;

            // 交換予定リストを計算
            const products = STATE.products.filter(p => !p.deleted && p.cycleDays);
            const scheduleMap = {};

            products.forEach(product => {
                const scheduleDate = calculateNextScheduleDate(product);
                if (scheduleDate) {
                    if (!scheduleMap[scheduleDate]) {
                        scheduleMap[scheduleDate] = [];
                    }
                    scheduleMap[scheduleDate].push(product);
                }
            });

            // 月の最初の日と最後の日
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            // カレンダーテーブル
            let html = `
                <div style="margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
            `;

            // 曜日ヘッダー
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; padding: 8px; font-weight: 600; font-size: 12px; color: ${day === '日' || day === '土' ? '#d32f2f' : '#333'};">${day}</div>`;
            });

            // 前月の日付
            for (let i = firstDay.getDay() - 1; i >= 0; i--) {
                const day = prevLastDay.getDate() - i;
                html += `<div style="padding: 8px; text-align: center; font-size: 12px; color: #ccc; background: #f9f9f9;">${day}</div>`;
            }

            // 当月の日付
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasSchedule = scheduleMap[dateStr] && scheduleMap[dateStr].length > 0;
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const dayOfWeek = new Date(year, month, day).getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                let bgColor = 'white';
                let textColor = '#333';
                let borderStyle = '1px solid #e0e0e0';

                if (isToday) {
                    bgColor = '#1a73e8';
                    textColor = 'white';
                    borderStyle = '2px solid #1a73e8';
                } else if (hasSchedule) {
                    bgColor = '#fff3e0';
                    borderStyle = '2px solid #f57f17';
                } else if (isWeekend) {
                    textColor = '#d32f2f';
                }

                html += `
                    <div onclick="selectCalendarDate('${dateStr}')" style="
                        padding: 8px 4px;
                        text-align: center;
                        font-size: 12px;
                        color: ${textColor};
                        background: ${bgColor};
                        border: ${borderStyle};
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${bgColor}'">
                        <div style="font-weight: 600;">${day}</div>
                        ${hasSchedule ? `<div style="font-size: 10px; color: #f57f17; font-weight: 600; margin-top: 2px;">${scheduleMap[dateStr].length}件</div>` : ''}
                    </div>
                `;
            }

            // 次月の日付
            const remainingDays = 42 - (firstDay.getDay() + lastDay.getDate());
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div style="padding: 8px; text-align: center; font-size: 12px; color: #ccc; background: #f9f9f9;">${day}</div>`;
            }

            html += `</div></div>`;
            container.innerHTML = html;
        }

        function selectCalendarDate(dateStr) {
            renderScheduleList(dateStr);
            // 選択日付をカレンダーに表示
            const allDays = document.querySelectorAll('#calendarContainer div[style*="cursor: pointer"]');
            allDays.forEach(day => {
                day.style.borderColor = day.textContent.includes('') ? '#f57f17' : '#e0e0e0';
            });
        }

        function calculateNextScheduleDate(product) {
            if (!product.cycleDays) return null;

            const lastUse = STATE.history
                .filter(h => h.productCode === product.code && h.type === 'use')
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime))[0];

            if (!lastUse) return null;

            const lastDate = new Date(lastUse.datetime);
            const nextDate = new Date(lastDate);
            nextDate.setDate(nextDate.getDate() + product.cycleDays);

            // 土日を除外
            while (nextDate.getDay() === 0 || nextDate.getDay() === 6) {
                nextDate.setDate(nextDate.getDate() + 1);
            }

            return nextDate.toISOString().split('T')[0];
        }

        function renderScheduleList(filterDate = null) {
            const container = document.getElementById('scheduleList');
            const products = STATE.products.filter(p => !p.deleted && p.cycleDays);

            let schedules = products.map(product => {
                const scheduleDate = calculateNextScheduleDate(product);
                return {
                    product: product,
                    scheduleDate: scheduleDate,
                    daysUntil: scheduleDate ? Math.ceil((new Date(scheduleDate) - new Date()) / (1000 * 60 * 60 * 24)) : Infinity
                };
            }).filter(s => s.scheduleDate);

            if (filterDate) {
                schedules = schedules.filter(s => s.scheduleDate === filterDate);
            } else {
                // フィルター無しの場合は、過去30日から未来30日までの予定を表示
                schedules = schedules.filter(s => s.daysUntil >= -30 && s.daysUntil <= 30);
            }

            schedules = schedules.sort((a, b) => a.daysUntil - b.daysUntil);

            if (schedules.length === 0) {
                const message = filterDate ? '予定されている交換はありません' : '交換予定がありません';
                container.innerHTML = `<div style="padding: 16px; text-align: center; color: #999; font-size: 13px;">${message}</div>`;
                return;
            }

            const headerDate = filterDate ? 
                new Date(filterDate).toLocaleString('ja-JP', { month: '2-digit', day: '2-digit', weekday: 'short' }) :
                '交換予定（過去30日～未来30日）';

            container.innerHTML = `<div style="padding: 12px 16px; font-weight: 600; color: #1a73e8; border-bottom: 1px solid #f0f0f0;">${headerDate}</div>` +
                schedules.map(s => {
                    const date = new Date(s.scheduleDate);
                    const dateStr = date.toLocaleString('ja-JP', {
                        month: '2-digit',
                        day: '2-digit'
                    });

                    let statusColor = '#9e9e9e';
                    let statusText = s.daysUntil + '日後';
                    if (s.daysUntil <= 0) {
                        statusColor = '#d32f2f';
                        statusText = '期限切れ';
                    } else if (s.daysUntil <= 7) {
                        statusColor = '#f57f17';
                    } else if (s.daysUntil <= 30) {
                        statusColor = '#388e3c';
                    }

                    const categoryBadge = s.product.category ? 
                        `<span style="background: ${getCategoryColor(s.product.category)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; margin-left: 4px;">${escapeHtml(s.product.category)}</span>` :
                        '';

                    return `
                        <div class="list-item" style="border-bottom: 1px solid #f0f0f0; padding: 12px 16px;">
                            <div class="list-item-header">
                                <div style="font-weight: 600; font-size: 14px; color: #333;">${escapeHtml(s.product.name)}</div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap;">${statusText}</span>
                            </div>
                            <div class="list-item-text" style="margin-top: 4px; font-size: 12px;">交換予定: ${dateStr} / 周期: ${s.product.cycleDays}日 ${categoryBadge}</div>
                        </div>
                    `;
                }).join('');
        }

        // ========================================
        // CSV エクスポート・インポート
        // ========================================
        function exportData(type) {
            let csv = '';
            let filename = '';

            if (type === 'master') {
                csv = 'コード,品名,メーカー,型式,カテゴリー,最低在庫,現在庫,金額,リードタイム,交換周期,備考\n';
                STATE.products.forEach(p => {
                    if (!p.deleted) {
                        csv += `"${p.code}","${p.name}","${p.maker || ''}","${p.model || ''}","${p.category || ''}",${p.minStock},${p.currentStock},${p.price || 0},${p.leadTime || 0},${p.cycleDays || ''},"${p.note || ''}"\n`;
                    }
                });
                filename = `在庫マスター_${new Date().toISOString().split('T')[0]}.csv`;
            } else if (type === 'history') {
                csv = '日時,コード,品名,カテゴリー,操作種別,数量,操作後在庫,理由,詳細理由\n';
                STATE.history.forEach(h => {
                    const datetime = new Date(h.datetime).toLocaleString('ja-JP');
                    csv += `"${datetime}","${h.productCode}","${h.productName}","${h.category || ''}","${h.type}",${h.quantity},${h.afterStock},"${h.reason || ''}","${h.detailReason || ''}"\n`;
                });
                filename = `操作履歴_${new Date().toISOString().split('T')[0]}.csv`;
            }

            downloadCSV(csv, filename);
        }

        function downloadCSV(csv, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function handleCsvImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = parseCSVLine(line);
                        const code = values[0]?.replace(/"/g, '').trim();

                        if (code) {
                            const existing = STATE.products.find(p => p.code === code);
                            const product = {
                                code: code,
                                name: values[1]?.replace(/"/g, '').trim() || '',
                                maker: values[2]?.replace(/"/g, '').trim() || '',
                                model: values[3]?.replace(/"/g, '').trim() || '',
                                category: values[4]?.replace(/"/g, '').trim() || '',
                                minStock: parseInt(values[5]) || 1,
                                currentStock: parseInt(values[6]) || 0,
                                price: parseInt(values[7]) || 0,
                                leadTime: parseInt(values[8]) || 0,
                                cycleDays: values[9] ? parseInt(values[9]) : null,
                                note: values[10]?.replace(/"/g, '').trim() || '',
                                deleted: false
                            };

                            if (existing) {
                                Object.assign(existing, product);
                            } else {
                                product.createdDate = new Date().toISOString();
                                STATE.products.push(product);
                            }
                        }
                    }

                    saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
                    renderMasterList();
                    renderCategoryFilter();
                    renderInventoryList();
                    alert('マスターデータをインポートしました');
                } catch (err) {
                    alert('CSVファイルの処理に失敗しました: ' + err.message);
                }
            };
            reader.readAsText(file, 'utf-8');

            document.getElementById('csvFileInput').value = '';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function backupAllData() {
            const backup = {
                products: STATE.products,
                history: STATE.history,
                orders: STATE.orders,
                categories: STATE.categories,
                makers: STATE.makers,
                backupDate: new Date().toISOString()
            };

            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `在庫管理バックアップ_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            alert('バックアップをダウンロードしました');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);

                        if (!confirm('このバックアップで全データを上書きしますか？\n操作は取り消せません')) {
                            return;
                        }

                        STATE.products = backup.products || [];
                        STATE.history = backup.history || [];
                        STATE.orders = backup.orders || [];
                        STATE.categories = backup.categories || [];
                        STATE.makers = backup.makers || [];

                        saveToStorage(STORAGE_KEYS.PRODUCTS, STATE.products);
                        saveToStorage(STORAGE_KEYS.HISTORY, STATE.history);
                        saveToStorage(STORAGE_KEYS.ORDERS, STATE.orders);
                        saveToStorage(STORAGE_KEYS.CATEGORIES, STATE.categories);
                        saveToStorage(STORAGE_KEYS.MAKERS, STATE.makers);

                        loadAllData();
                        renderCurrentScreen();
                        alert('データを復元しました');
                    } catch (err) {
                        alert('復元に失敗しました: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========================================
        // モーダル制御
        // ========================================
        function lockBodyScroll() {
            // スクロールバー幅を計算して body にパディングを追加し、表示ズレを防ぐ
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
            }
            lockBodyScroll();
        }

        function unlockBodyScroll() {
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            // 棚卸モーダルを閉じるときは進捗を保存して一時停止状態にする
            if (modalId === 'stocktakeModal' && STATE.stocktakeMode) {
                saveStocktakeProgress();
            }
            modal.classList.remove('show');
            unlockBodyScroll();
        }

        function renderCurrentScreen() {
            const screenName = STATE.currentScreen;
            const contentArea = document.getElementById(screenName);
            if (contentArea) {
                if (screenName === 'inventory') {
                    renderCategoryFilter();
                    renderInventoryList();
                } else if (screenName === 'master') {
                    renderMasterList();
                } else if (screenName === 'calendar') {
                    renderCalendarScreen();
                }
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ========================================
        // アプリ初期化
        // ========================================
        window.addEventListener('DOMContentLoaded', initApp);

        // iOS Safari 対応
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
            document.addEventListener('touchmove', (e) => {
                if (document.body.classList.contains('modal-open')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
    </script>
</body>
</html>
